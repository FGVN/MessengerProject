@page "/chats"
@inject FindChatsQueryHandler queryHandler
@inject DeleteChatCommandHandler deleteChatHandler
@inject NavigationManager navigationManager
@inject CreateChatCommandHandler createChatHandler
@inject FindUsersQueryHandler findUsersQueryHandler

<AuthorizeView>
    <Authorized>
        <form @onsubmit="HandleSearch">
            <MatTextField TValue="string" @bind-Value="Query" Label="Search" Dense="true" />
            <MatTextField TValue="string" @bind-Value="SortBy" Label="Sort By" Dense="true" />
            <MatTextField TValue="string" @bind-Value="SortDirection" Label="Sort Direction" Dense="true" />
            <MatTextField TValue="string" @bind-Value="PropertiesToGet" Label="Properties to Retrieve" Dense="true" />
            <MatButton Type="submit" Raised="true" Dense="true">Search</MatButton>
        </form>
        <MatSelect @bind-Value="selectedContactUsername" Label="Select Contact Username" Dense="true">
            @foreach (var username in contactUsernames)
            {
                <MatOption Value="@username">@username</MatOption>
            }
        </MatSelect>
        
        <MatButton OnClick="@CreateNewChat">Create New Chat</MatButton>
        <MatTable Items="@chats">
            <MatTableHeader>
                <th>ChatId</th>
                <th>Username</th>
                <th>ContactUsername</th>
                <th>Actions</th> <!-- New column for delete button -->
            </MatTableHeader>
            <MatTableRow Context="tableRowContext">
                <td>@tableRowContext.ChatId</td>
                <td>@tableRowContext.Username</td>
                <td>@tableRowContext.ContactUsername</td>
                <td>
                    <MatButton OnClick="@(() => NavigateToChat(tableRowContext.ChatId))">View Messages</MatButton>
                    <MatButton OnClick="@(() => DeleteChat(tableRowContext.ChatId))">Delete</MatButton> <!-- New delete button -->
                </td>
            </MatTableRow>
        </MatTable>

        <MatPagination TotalItems="totalChatsCount" PageSize="PageSize" CurrentPage="PageNumber" OnPageChange="HandlePageChange" />
    </Authorized>
</AuthorizeView>

@code {
    private string Query { get; set; }
    private string SortBy { get; set; }
    private string SortDirection { get; set; }
    private string PropertiesToGet { get; set; }
    private IEnumerable<ChatMenuItem> chats;
    private int PageNumber = 1;
    private int totalChatsCount;
    private const int PageSize = 10;

    private string selectedContactUsername;
    private List<string> contactUsernames = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        var res = await findUsersQueryHandler.Handle(new FindUsersQuery
            {
                Query = "a",
                From = 0,
                To = 100,
                SortBy = "username",
                SortDirection = "asc"
            }, 1);
        contactUsernames = res.Select(x => x.Username).ToList();
        StateHasChanged();
    }

    private async Task HandleSearch()
    {
        PageNumber = 1;
        await LoadChats();
    }

    private async Task LoadChats()
    {
        var findChatsQuery = new FindChatsQuery
        {
            Query = Query,
            SortBy = SortBy,
            SortDirection = SortDirection,
            From = (PageNumber - 1) * PageSize,
            To = PageNumber * PageSize,
            PropertiesToRetrieve = string.IsNullOrWhiteSpace(PropertiesToGet) ? null : PropertiesToGet.Split(',').Select(p => p.Trim())
        };
        var result = await queryHandler.Handle(findChatsQuery, PageNumber);
        chats = result;
        totalChatsCount = result.Count();
        StateHasChanged();
    }

    private async Task HandlePageChange(int newPageIndex)
    {
        PageNumber = newPageIndex + 1;
        await LoadChats();
    }
    private void NavigateToChat(Guid chatId)
    {
        navigationManager.NavigateTo($"/chats/{chatId}");
    }

    private async Task DeleteChat(Guid chatId)
    {
        try
        {
            // Call the delete chat handler to delete the chat
            await deleteChatHandler.Handle(chatId);
            // Reload chats after deletion
            await LoadChats();
        }
        catch (Exception ex)
        {
            // Handle exception
            Console.WriteLine($"Error deleting chat: {ex.Message}");
        }
    }
    private async Task CreateNewChat()
    {
        try
        {
            // Handle the creation of a new chat
            var chatId = await createChatHandler.Handle(selectedContactUsername);
            // Redirect to the created chat page or do any necessary actions
            navigationManager.NavigateTo($"/chats/{chatId}");
        }
        catch (Exception ex)
        {
            // Handle exception
            Console.WriteLine($"Error creating chat: {ex.Message}");
        }
    }
}
